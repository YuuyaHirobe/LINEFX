# AGENTS.md

このファイルは `C:\LINEbot` で作業する Codex エージェント向けの運用ガイドです。

## プロジェクトの目的
- Google スプレッドシートの編集を検知し、LINEグループへ自動通知する。
- 想定構成は以下。
  - Apps Script (`gas/Code.gs`): `onEdit` トリガーで変更情報をWebhook送信
  - Node.js サーバー (`src/server.js`): `/notify` 受信後に LINE Messaging API でグループへPush

## このリポジトリの責務
- 通知メッセージ生成ロジック
- Webhookエンドポイントの認証（`x-api-key`）
- LINEグループ送信先の管理（`.env` の `LINE_GROUP_ID` またはリクエスト指定）
- 運用手順の文書化（`README.md`）

## 非対象（勝手に広げない）
- DB導入や大規模なジョブ基盤化
- 複雑な権限管理UIの追加
- スプレッドシート全イベント対応（必要時のみ追加提案）

## 基本方針
- 返答は日本語で行う。
- まず現状確認してから編集する。
- 変更は最小単位で実施し、無関係な修正を混ぜない。
- 意図不明の既存挙動は壊さず、必要ならユーザーに確認する。

## 作業フロー
1. 依頼内容を1〜2文で要約して合意する。
2. `rg --files` と `rg` で対象を特定する。
3. 編集前に影響範囲を明示する。
4. 修正後に可能な範囲で検証する。
5. 最終報告で以下を必ず記載する。
   - 変更ファイル
   - 変更点の要約
   - 検証コマンドと結果
   - 未実施・要確認事項

## 実装ルール（この案件向け）
- 秘密情報はコードに直書きしない（`.env` / Apps Script プロパティを使用）。
- `NOTIFY_API_KEY` は Apps Script 側とサーバー側で一致させる。
- 受信データが欠けてもサーバーが500で落ちにくい実装を優先する。
- 通知文は「どのシートのどのセルがどう変わったか」を最優先で出す。
- 例外時は握りつぶさずログを残す。

## 変更優先順位
1. 正しさ（誤通知・未通知を防ぐ）
2. 安全性（認証、秘密情報、破壊的操作回避）
3. 運用性（ログ、設定容易性、README整備）
4. 追加機能（フィルタ、整形、拡張）

## 検証チェックリスト
- `node --check src/server.js` が成功する。
- `/healthz` が `200` を返す。
- Apps Script から `/notify` に送ったとき `401`/`400` にならない。
- LINEグループに通知が届く。
- 不正な `x-api-key` では `401` になる。

## 依頼テンプレート（ユーザー向け）
```md
目的:
対象ファイル/機能:
やってほしいこと:
制約（ライブラリ追加禁止、互換性要件など）:
完了条件:
```

## 最終報告テンプレート（エージェント向け）
```md
実施内容:
- ...

変更ファイル:
- path/to/file

検証:
- 実行コマンド:
- 結果:

補足:
- 未実施・懸念点
```
